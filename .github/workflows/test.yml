name: Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgc-dev \
          libncurses-dev \
          libssl-dev \
          zlib1g-dev \
          build-essential \
          curl \
          wget
    
    - name: Configure
      run: ./configure --enable-ssl --enable-ipv6 --enable-unicode
    
    - name: Build
      run: make -j$(nproc)
    
    - name: Run basic tests
      run: |
        set -e
        echo "=== Testing w3m version ==="
        ./w3m -version
        
        echo "=== Testing help output ==="
        ./w3m -help > /dev/null
        
        echo "=== Testing local HTML file ==="
        cat > test.html << EOF
        <!DOCTYPE html>
        <html>
        <head><title>Test Page</title></head>
        <body>
          <h1>Hello World</h1>
          <p>This is a test page.</p>
          <a href="#section">Link to section</a>
          <div id="section">Section content</div>
        </body>
        </html>
        EOF
        ./w3m -dump test.html | grep -q "Hello World"
        
        echo "=== Testing URL parsing ==="
        ./w3m -dump https://example.com > /dev/null 2>&1
        
        echo "=== Testing HTTPS ==="
        ./w3m -dump_head https://example.com | grep -q "200 OK"
    
    - name: Test redirect handling
      run: |
        set -e
        echo "=== Testing redirect loop detection ==="
        # Test that Wikipedia doesn't trigger false redirect loop
        timeout 10 ./w3m -dump "https://en.wikipedia.org/wiki/Hello_World" 2>&1 | grep -q "Hello World" || true
        
        # Test URL with query parameters
        timeout 10 ./w3m -dump "https://example.com/?test=1" > /dev/null 2>&1
    
    - name: Test encoding support
      run: |
        set -e
        echo "=== Testing UTF-8 support ==="
        echo '<html><body>日本語 中文 한글</body></html>' > utf8.html
        ./w3m -dump utf8.html > /dev/null
        
        echo "=== Testing HTML entities ==="
        echo '<html><body>&lt;test&gt; &amp; &quot;quotes&quot;</body></html>' > entities.html
        ./w3m -dump entities.html | grep -q "<test>"

  integration-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgc-dev \
          libncurses-dev \
          libssl-dev \
          zlib1g-dev \
          build-essential \
          python3 \
          python3-pip
    
    - name: Configure and build
      run: |
        ./configure --enable-ssl --enable-ipv6 --enable-unicode
        make -j$(nproc)
    
    - name: Setup test server
      run: |
        cat > test_server.py << 'EOF'
        from http.server import HTTPServer, BaseHTTPRequestHandler
        import json
        
        class TestHandler(BaseHTTPRequestHandler):
            def do_GET(self):
                if self.path == '/redirect-loop':
                    self.send_response(302)
                    self.send_header('Location', '/redirect-loop')
                    self.end_headers()
                elif self.path == '/redirect-once':
                    self.send_response(302)
                    self.send_header('Location', '/final')
                    self.end_headers()
                elif self.path == '/final':
                    self.send_response(200)
                    self.send_header('Content-Type', 'text/html')
                    self.end_headers()
                    self.wfile.write(b'<html><body>Final page</body></html>')
                else:
                    self.send_response(200)
                    self.send_header('Content-Type', 'text/html')
                    self.end_headers()
                    self.wfile.write(b'<html><body>Test page</body></html>')
            
            def log_message(self, format, *args):
                pass  # Suppress logs
        
        if __name__ == '__main__':
            server = HTTPServer(('localhost', 8080), TestHandler)
            print("Test server started on port 8080")
            server.serve_forever()
        EOF
        
        python3 test_server.py &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        sleep 2
    
    - name: Run integration tests
      run: |
        set -e
        echo "=== Testing normal page load ==="
        ./w3m -dump http://localhost:8080/ | grep -q "Test page"
        
        echo "=== Testing single redirect ==="
        ./w3m -dump http://localhost:8080/redirect-once | grep -q "Final page"
        
        echo "=== Testing redirect loop detection ==="
        # This should detect the redirect loop and fail gracefully
        timeout 5 ./w3m -dump http://localhost:8080/redirect-loop 2>&1 | grep -q "Redirection loop detected" || echo "Redirect loop handled"
    
    - name: Cleanup
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

  memory-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgc-dev \
          libncurses-dev \
          libssl-dev \
          build-essential \
          valgrind
    
    - name: Configure and build
      run: |
        ./configure --enable-ssl --disable-image
        make -j$(nproc)
    
    - name: Run memory tests with valgrind
      run: |
        echo '<html><body>Test</body></html>' > test.html
        
        # Basic memory leak test
        valgrind --leak-check=summary --error-exitcode=1 \
          ./w3m -dump test.html > /dev/null 2>&1 || true
        
        echo "Memory test completed"
